<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng C·ª• N·∫°p ESP32-S3 - Phi√™n b·∫£n 5 Firmware</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="https://unpkg.com/esp-web-tools@9/dist/web/install-button.js?module"></script>
    <style>
        :root { --primary: #00c9ff; --success: #28a745; --danger: #dc3545; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8f9fa; color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); overflow: hidden; }
        header { background: linear-gradient(135deg, #2c3e50, #1a2530); color: white; padding: 25px; text-align: center; }
        h1 { font-size: 1.8rem; margin-bottom: 5px; }
        .subtitle { font-size: 0.9rem; opacity: 0.9; }
        .main-content { padding: 25px; }
        .section { margin-bottom: 30px; }
        h2 { color: #2c3e50; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #eee; display: flex; align-items: center; gap: 10px; font-size: 1.2rem; }
        .method-card { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #dee2e6; }
        
        /* CSS cho n√∫t n·∫°p ch√≠nh - ƒê√É C·∫¨P NH·∫¨T */
        #installButton {
            --esp-tools-button-color: #00c9ff;
            --esp-tools-button-hover-color: #00a8d6;
            --esp-tools-border-radius: 8px;
            --esp-tools-font-size: 1rem;
            --esp-tools-padding: 12px 24px;
            width: 100%;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        
        #installButton::part(button) {
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 201, 255, 0.2);
            border: none;
            cursor: pointer;
        }
        
        #installButton::part(button):hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 201, 255, 0.3);
        }
        
        #installButton::part(button):active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 201, 255, 0.2);
        }
        
        .input-group { margin-top: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #495057; }
        input[type="url"], input[type="text"] { width: 100%; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 5px; font-size: 0.95rem; transition: border-color 0.3s; }
        input:focus { border-color: var(--primary); outline: none; }
        .btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-align: center; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #00a8d6; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover { background-color: #218838; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-info:hover { background-color: #138496; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        .status-log { background-color: #1a1a1a; color: #e0e0e0; padding: 15px; border-radius: 5px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85rem; height: 250px; overflow-y: auto; margin-top: 20px; white-space: pre-wrap; }
        .log-entry { margin-bottom: 5px; line-height: 1.4; }
        .log-time { color: #6c757d; }
        .log-info { color: #17a2b8; }
        .log-success { color: var(--success); }
        .log-error { color: var(--danger); }
        .log-warning { color: #ffc107; }
        footer { text-align: center; padding: 20px; color: #6c757d; font-size: 0.85rem; border-top: 1px solid #eee; }
        .hidden { display: none; }
        .url-hint { font-size: 0.8rem; color: #6c757d; margin-top: 5px; }
        #githubUrl { font-family: monospace; }
        .button-group { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .button-group .btn { width: 100%; }
        .default-firmware-info { background-color: #e7f3ff; border-left: 4px solid var(--primary); padding: 10px; margin-top: 10px; border-radius: 0 4px 4px 0; font-size: 0.9rem; }
        .firmware-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 15px; }
        .firmware-option { background: white; border: 2px solid #dee2e6; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .firmware-option:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .firmware-option.active { border-color: var(--success); background-color: #f0fff4; }
        .firmware-icon { font-size: 2rem; margin-bottom: 10px; color: var(--primary); }
        .firmware-name { font-weight: 600; margin-bottom: 5px; }
        .firmware-desc { font-size: 0.8rem; color: #6c757d; }
        .selected-info { margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; border-left: 4px solid var(--primary); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-microchip"></i> ESP32-S3 Web Flasher</h1>
            <p class="subtitle">N·∫°p t·ª´ file m√°y t√≠nh ho·∫∑c ch·ªçn 1 trong 5 firmware tr·ª±c tuy·∫øn</p>
        </header>
        <div class="main-content">
            <!-- Ph·∫ßn 1: N·∫†P T·ª™ FILE TR√äN M√ÅY -->
            <div class="section">
                <h2><i class="fas fa-upload"></i> 1. N·∫°p t·ª´ file tr√™n m√°y</h2>
                <div class="method-card">
                    <p>Ch·ªçn file firmware <code>.bin</code> t·ª´ m√°y t√≠nh c·ªßa b·∫°n ƒë·ªÉ n·∫°p v√†o chip S3.</p>
                    <div class="input-group">
                        <input type="file" id="localFile" accept=".bin" style="display: none;">
                        <button onclick="document.getElementById('localFile').click()" class="btn btn-secondary">
                            <i class="fas fa-folder-open"></i> Ch·ªçn file .bin t·ª´ m√°y t√≠nh
                        </button>
                        <span id="localFileName" style="margin-left: 15px; font-weight:500;"></span>
                    </div>
                </div>
            </div>

            <!-- Ph·∫ßn 2: CH·ªåN FIRMWARE TR·ª∞C TUY·∫æN (5 l·ª±a ch·ªçn) -->
            <div class="section">
                <h2><i class="fas fa-cloud-download-alt"></i> 2. Ch·ªçn firmware tr·ª±c tuy·∫øn</h2>
                <div class="method-card">
                    <p>Ch·ªçn 1 trong 5 firmware d∆∞·ªõi ƒë√¢y ƒë·ªÉ n·∫°p tr·ª±c tuy·∫øn Oline:</p>
                    
                    <!-- L∆∞·ªõi ch·ªçn firmware -->
                    <div class="firmware-grid">
                        <!-- Firmware 1 -->
                        <div class="firmware-option" onclick="selectOnlineFirmware(0)">
                            <div class="firmware-icon"><i class="fas fa-microchip"></i></div>
                            <div class="firmware-name">b·∫£n chu·∫©n 160x80</div>
                            <div class="firmware-desc">Phi√™n b·∫£n chu·∫©n 160x80</div>
                        </div>
                        
                        <!-- Firmware 2 -->
                        <div class="firmware-option" onclick="selectOnlineFirmware(1)">
                            <div class="firmware-icon"><i class="fas fa-microchip"></i></div>
                            <div class="firmware-name">d√†nh cho Otto</div>
                            <div class="firmware-desc">cho m·∫°ch Otto</div>
                        </div>
                        
                        <!-- Firmware 3 -->
                        <div class="firmware-option" onclick="selectOnlineFirmware(2)">
                            <div class="firmware-icon"><i class="fas fa-microchip"></i></div>
                            <div class="firmware-name">S3 160x80 c·∫≠p nh·∫≠t</div>
                            <div class="firmware-desc">S3 c·∫≠p nh·∫≠t</div>
                        </div>
                        
                        <!-- Firmware 4 -->
                        <div class="firmware-option" onclick="selectOnlineFirmware(3)">
                            <div class="firmware-icon"><i class="fas fa-microchip"></i></div>
                            <div class="firmware-name">S3 160x80 bo c≈© ƒë·∫£o LCD</div>
                            <div class="firmware-desc">phi√™n b·∫£n c≈© ƒë·∫£o ch√¢n LCD</div>
                        </div>
                        
                        <!-- Firmware 5 -->
                        <div class="firmware-option" onclick="selectOnlineFirmware(4)">
                            <div class="firmware-icon"><i class="fas fa-microchip"></i></div>
                            <div class="firmware-name">m·∫°ch t√≠m Oled 0.96</div>
                            <div class="firmware-desc"> m·∫°ch Oled 0.96 chung</div>
                        </div>
                    </div>
                    
                    <!-- Th√¥ng tin firmware ƒë√£ ch·ªçn -->
                    <div id="selectedFirmwareInfo" class="selected-info" style="display: none;">
                        <strong><i class="fas fa-check-circle"></i> ƒê√£ ch·ªçn:</strong>
                        <span id="selectedFirmwareName">T√™n firmware</span>
                        <div id="selectedFirmwareDetails" style="font-size: 0.85rem; margin-top: 5px;"></div>
                    </div>
                    
                    <div class="url-hint" style="margin-top: 15px;">
                        <i class="fas fa-info-circle"></i> <strong>Ch√∫ √Ω:</strong> ch·ªçn ƒë√∫ng phi√™n b·∫£n c·∫ßn n·∫°p. n·∫øu n·∫°p sai h√£y ƒë·ª£i n·∫°p song v√† n·∫°p l·∫°i (t√¨m bi·∫øn FIRMWARE_LIST).
                    </div>
                </div>
            </div>

            <!-- Ph·∫ßn 3: B·∫ÆT ƒê·∫¶U N·∫†P V√ÄO THI·∫æT B·ªä -->
            <div class="section">
                <h2><i class="fas fa-play-circle"></i> 3. B·∫Øt ƒë·∫ßu n·∫°p v√†o thi·∫øt b·ªã</h2>
                <div class="method-card">
                    <p><strong>B∆∞·ªõc cu·ªëi c√πng:</strong> Sau khi ch·ªçn firmware ·ªü tr√™n, nh·∫•n n√∫t b√™n d∆∞·ªõi h√¨nh <i class="fas fa-plug"></i> v√† ch·ªçn c·ªïng COM </span>  ƒë·ªÉ k·∫øt n·ªëi v·ªõi ESP32-S3 v√† b·∫Øt ƒë·∫ßu qu√° tr√¨nh n·∫°p.</p>
                    
                    <!-- N√öT CH√çNH V·ªöI HI·ªÜU ·ª®NG HOVER -->
                    <esp-web-install-button id="installButton">
                        <span slot="activate"><i class="fas fa-plug"></i> B·∫•m K·∫øt n·ªëi ESP32-S3 & B·∫Øt ƒë·∫ßu n·∫°p</span>
                        <span slot="unsupported">Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£. Vui l√≤ng d√πng Chrome/Edge.</span>
                        <span slot="not-allowed">ƒê√£ t·ª´ ch·ªëi truy c·∫≠p c·ªïng Serial. H√£y th·ª≠ l·∫°i.</span>
                    </esp-web-install-button>
                    
                    <p class="url-hint" style="margin-top: 10px;">
                        <i class="fas fa-mouse-pointer"></i> <strong>Di chu·ªôt v√†o h√¨nh k·∫øt n·ªëi v√† b·∫•m ƒë·ªÉ ch·ªçn c·ªïng COM</strong>
                    </p>
                </div>
            </div>

            <!-- Ph·∫ßn 4: LOG H·ªÜ TH·ªêNG -->
            <div class="section">
                <h2><i class="fas fa-terminal"></i> Nh·∫≠t k√Ω h·ªá th·ªëng</h2>
                <div class="status-log" id="statusLog">
                    <div class="log-entry log-info">[H·ªá th·ªëng] C√¥ng c·ª• ƒë√£ s·∫µn s√†ng. Vui l√≤ng ch·ªçn ngu·ªìn firmware.</div>
                </div>
                <div style="text-align: right; margin-top:10px;">
                    <button onclick="clearLog()" class="btn btn-secondary btn-sm"><i class="fas fa-trash"></i> X√≥a log</button>
                </div>
            </div>
        </div>
        <footer>
            <p>ESP Web Flasher | Phi√™n b·∫£n 5 Firmware | D·ª±a tr√™n ESP Web Tools</p>
        </footer>
    </div>

    <script>
        // ========== C·∫§U H√åNH QUAN TR·ªåNG: DANH S√ÅCH 5 FIRMWARE ==========
        // üîß B·∫†N C·∫¶N THAY ƒê·ªîI C√ÅC URL D∆Ø·ªöI ƒê√ÇY B·∫∞NG "RAW URL" C·ª¶A B·∫†N!
        const FIRMWARE_LIST = [
            {
                name: "S3 160x80 chu·∫©n",
                description: "Phi√™n b·∫£n c∆° b·∫£n ti√™u chu·∫©n",
                url: "https://raw.githubusercontent.com/vnthao/nap/main/firmware/C/merged-binary.bin",  // Thay URL 1 c·ªßa b·∫°n
                icon: "fas fa-microchip"
            },
            {
                name: "Firmware Otto",
                description: "Firmware d√†nh ri√™ng cho Otto chu·∫©n",
                url: "https://raw.githubusercontent.com/vnthao/nap/main/firmware/otto-board-pcb-chuan.bin", // üîß THAY URL 2 C·ª¶A B·∫†N
                icon: "fas fa-wifi"
            },
            {
                name: "S3 160x80 c·∫≠p nh·∫≠t",
                description: "Firmware c·∫≠p nh·∫≠t th∆∞·ªùng xuy√™n t√≠nh nƒÉng m·ªõi",
                url: "https://raw.githubusercontent.com/vnthao/nap/main/firmware/C/merged-binary.bin", // üîß THAY URL 3 C·ª¶A B·∫†N
                icon: "fas fa-server"
            },
            {
                name: "S3 160x80 bo c≈© ƒë·∫£o LCD",
                description: "Firmware d√†nh cho c√°c b·∫£n c≈© c·ªßa kh√°ch h√†ng",
                url: "https://raw.githubusercontent.com/vnthao/nap/main/firmware/D/merged-binary.bin", // üîß THAY URL 4 C·ª¶A B·∫†N
                icon: "fas fa-sd-card"
            },
            {
                name: "m·∫°ch t√≠m Oled 0.96",
                description: "Firmware n√¢ng cao v·ªõi nhi·ªÅu t√≠nh nƒÉng",
                url: "https://raw.githubusercontent.com/vnthao/nap/main/firmware/oled-0.96.bin", // üîß THAY URL 5 C·ª¶A B·∫†N
                icon: "fas fa-robot"
            }
        ];

        // ========== BI·∫æN TO√ÄN C·ª§C ==========
        let currentManifestObject = null;
        let selectedOnlineFirmwareIndex = -1; // -1 nghƒ©a l√† ch∆∞a ch·ªçn firmware n√†o

        // ========== H√ÄM LOG ==========
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('statusLog');
            const time = new Date().toLocaleTimeString('vi-VN', { hour12: false });
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            const typeClassMap = { 'info': 'log-info', 'success': 'log-success', 'error': 'log-error', 'warning': 'log-warning' };
            logEntry.innerHTML = `<span class="log-time">[${time}]</span> <span class="${typeClassMap[type] || 'log-info'}">${message}</span>`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('statusLog').innerHTML = '';
            addLog('ƒê√£ x√≥a nh·∫≠t k√Ω.', 'info');
        }

        // ========== PH·∫¶N 1: X·ª¨ L√ù FILE LOCAL ==========
        document.getElementById('localFile').addEventListener('change', async function(e) {
            if (!e.target.files.length) return;
            const file = e.target.files[0];
            const fileNameEl = document.getElementById('localFileName');

            if (!file.name.toLowerCase().endsWith('.bin')) {
                addLog(`‚ùå File "${file.name}" kh√¥ng ph·∫£i file .bin h·ª£p l·ªá.`, 'error');
                fileNameEl.textContent = 'File kh√¥ng h·ª£p l·ªá!';
                fileNameEl.style.color = 'var(--danger)';
                return;
            }

            // H·ªßy ch·ªçn firmware tr·ª±c tuy·∫øn n·∫øu c√≥
            if (selectedOnlineFirmwareIndex !== -1) {
                document.querySelectorAll('.firmware-option').forEach(opt => opt.classList.remove('active'));
                selectedOnlineFirmwareIndex = -1;
                document.getElementById('selectedFirmwareInfo').style.display = 'none';
            }

            fileNameEl.textContent = `üìÑ ${file.name} (${(file.size / (1024*1024)).toFixed(2)} MB)`;
            fileNameEl.style.color = 'var(--success)';
            addLog(`ƒê√£ ch·ªçn file t·ª´ m√°y t√≠nh: "${file.name}"`, 'success');

            const fileObjectUrl = URL.createObjectURL(file);
            const manifest = {
                name: `Local: ${file.name}`,
                version: "1.0.0",
                builds: [{ chipFamily: "ESP32-S3", parts: [{ path: fileObjectUrl, offset: 0x00000 }] }]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);

            updateInstallButton(manifestUrl);
            currentManifestObject = { manifestUrl, fileObjectUrl };
            addLog('‚úÖ Firmware ƒë√£ s·∫µn s√†ng. B·∫•m n√∫t <span style="color:#00c9ff">"K·∫øt n·ªëi ESP32-S3 & B·∫Øt ƒë·∫ßu n·∫°p"</span> ƒë·ªÉ ti·∫øp t·ª•c.', 'info');
        });

        // ========== PH·∫¶N 2: CH·ªåN FIRMWARE TR·ª∞C TUY·∫æN ==========
        async function selectOnlineFirmware(index) {
            // Ki·ªÉm tra index h·ª£p l·ªá
            if (index < 0 || index >= FIRMWARE_LIST.length) {
                addLog(`‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y firmware v·ªõi index ${index}`, 'error');
                return;
            }

            const firmware = FIRMWARE_LIST[index];
            
            // Ki·ªÉm tra URL
            if (!firmware.url || firmware.url.includes('YOUR_FIRMWARE')) {
                addLog(`‚ùå Ch∆∞a c·∫•u h√¨nh URL cho ${firmware.name}. Vui l√≤ng c·∫≠p nh·∫≠t trong code.`, 'error');
                alert(`L·ªói: Ch∆∞a c·∫•u h√¨nh URL cho ${firmware.name}.\n\nVui l√≤ng thay th·∫ø URL trong bi·∫øn FIRMWARE_LIST (ph·∫ßn JavaScript).`);
                return;
            }

            // C·∫≠p nh·∫≠t giao di·ªán: ƒë√°nh d·∫•u firmware ƒë∆∞·ª£c ch·ªçn
            document.querySelectorAll('.firmware-option').forEach(opt => opt.classList.remove('active'));
            document.querySelectorAll('.firmware-option')[index].classList.add('active');
            
            // X√≥a th√¥ng tin file local n·∫øu c√≥
            document.getElementById('localFileName').textContent = '';
            
            // Hi·ªÉn th·ªã th√¥ng tin firmware ƒë√£ ch·ªçn
            document.getElementById('selectedFirmwareName').textContent = firmware.name;
            document.getElementById('selectedFirmwareDetails').textContent = firmware.description;
            document.getElementById('selectedFirmwareInfo').style.display = 'block';
            
            selectedOnlineFirmwareIndex = index;
            
            addLog(`üîç ƒêang ki·ªÉm tra firmware: ${firmware.name}...`, 'info');

            try {
                // Ki·ªÉm tra file c√≥ t·ªìn t·∫°i kh√¥ng
                const testResponse = await fetch(firmware.url, { method: 'HEAD' });
                if (!testResponse.ok) throw new Error(`HTTP ${testResponse.status}`);

                const fileSize = testResponse.headers.get('content-length');
                const sizeText = fileSize ? ` (${(fileSize / (1024*1024)).toFixed(2)} MB)` : '';

                // T·∫°o manifest cho firmware n√†y
                const manifest = {
                    name: firmware.name,
                    version: "1.0",
                    builds: [{
                        chipFamily: "ESP32-S3",
                        parts: [{ path: firmware.url, offset: 0x00000 }]
                    }]
                };

                const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                const manifestUrl = URL.createObjectURL(manifestBlob);

                updateInstallButton(manifestUrl);
                currentManifestObject = { manifestUrl };

                addLog(`‚úÖ ƒê√£ thi·∫øt l·∫≠p ${firmware.name} th√†nh c√¥ng!${sizeText}`, 'success');
                addLog('üëâ B·∫•m n√∫t <span style="color:#00c9ff">"K·∫øt n·ªëi ESP32-S3 & B·∫Øt ƒë·∫ßu n·∫°p"</span> ƒë·ªÉ b·∫Øt ƒë·∫ßu n·∫°p.', 'info');

            } catch (error) {
                addLog(`‚ùå Kh√¥ng th·ªÉ t·∫£i ${firmware.name}: ${error.message}`, 'error');
                alert(`Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn firmware ${firmware.name}.\n\nL·ªói: ${error.message}\n\nH√£y ƒë·∫£m b·∫£o:\n1. URL '${firmware.url}' l√† ƒë√∫ng.\n2. File ƒë√£ ƒë∆∞·ª£c upload v√† c√¥ng khai tr√™n GitHub.\n3. B·∫°n ƒëang s·ª≠ d·ª•ng "Raw URL".`);
            }
        }

        // ========== C·∫¨P NH·∫¨T N√öT C√ÄI ƒê·∫∂T ==========
        const installButton = document.getElementById('installButton');

        function updateInstallButton(manifestUrl) {
            if (installButton.hasAttribute('manifest')) installButton.removeAttribute('manifest');
            setTimeout(() => installButton.setAttribute('manifest', manifestUrl), 50);
        }

        // ========== L·∫ÆNG NGHE S·ª∞ KI·ªÜN TH·ª∞C T·∫æ ==========
        installButton.addEventListener('state-changed', (event) => {
            const state = event.detail.state;
            switch (state) {
                case 'idle': addLog('[Tr·∫°ng th√°i] S·∫µn s√†ng.', 'info'); break;
                case 'installing': addLog('[Tr·∫°ng th√°i] üî• ƒêang n·∫°p firmware v√†o ESP32-S3... Vui l√≤ng kh√¥ng ng·∫Øt k·∫øt n·ªëi.', 'warning'); break;
                case 'installed': addLog('[Tr·∫°ng th√°i] ‚úÖ N·∫°p firmware HO√ÄN T·∫§T! Thi·∫øt b·ªã s·∫Ω t·ª± ƒë·ªông kh·ªüi ƒë·ªông l·∫°i.', 'success'); cleanupObjectUrls(); break;
                case 'error': addLog(`[Tr·∫°ng th√°i] ‚ùå L·ªói: ${event.detail.message || 'Nguy√™n nh√¢n kh√¥ng x√°c ƒë·ªãnh.'}`, 'error'); break;
            }
        });
        
        installButton.addEventListener('device-connected', () => addLog('[Thi·∫øt b·ªã] üìç ƒê√£ k·∫øt n·ªëi v·ªõi ESP32-S3.', 'success'));
        installButton.addEventListener('manifest-loaded', () => addLog('[Firmware] ‚úÖ ƒê√£ x√°c th·ª±c th√¥ng tin firmware.', 'info'));

        // ========== D·ªåN D·∫∏P B·ªò NH·ªö ==========
        function cleanupObjectUrls() {
            if (currentManifestObject) {
                URL.revokeObjectURL(currentManifestObject.manifestUrl);
                if (currentManifestObject.fileObjectUrl) URL.revokeObjectURL(currentManifestObject.fileObjectUrl);
                currentManifestObject = null;
                addLog('[H·ªá th·ªëng] ƒê√£ d·ªçn d·∫πp b·ªô nh·ªõ t·∫°m.', 'info');
            }
        }

        // ========== KH·ªûI T·∫†O ==========
        window.onload = function() {
            addLog('[H·ªá th·ªëng] C√¥ng c·ª• n·∫°p ESP32-S3 ƒë√£ kh·ªüi ƒë·ªông.', 'info');
            addLog('[H∆∞·ªõng d·∫´n] Ch·ªçn "N·∫°p t·ª´ file tr√™n m√°y" HO·∫∂C ch·ªçn 1 trong 5 firmware tr·ª±c tuy·∫øn.', 'info');
            
            // Ki·ªÉm tra c·∫•u h√¨nh firmware
            let unconfiguredCount = 0;
            FIRMWARE_LIST.forEach((fw, index) => {
                if (!fw.url || fw.url.includes('YOUR_FIRMWARE')) {
                    unconfiguredCount++;
                    addLog(`[C·∫£nh b√°o] Firmware ${index + 1} ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh URL.`, 'warning');
                }
            });
            
            if (unconfiguredCount > 0) {
                addLog(`[C·∫£nh b√°o] C√≥ ${unconfiguredCount} firmware ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh URL. Vui l√≤ng c·∫≠p nh·∫≠t trong code.`, 'warning');
            }
        };
    </script>
</body>
</html>
