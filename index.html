<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-S3 Web Flasher - Fixed Version</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="https://unpkg.com/esp-web-tools@9/dist/web/install-button.js?module"></script>
    <style>
        /* Gi·ªØ nguy√™n to√†n b·ªô CSS t·ª´ phi√™n b·∫£n tr∆∞·ªõc */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f5f5f5; color: #333; line-height: 1.6; padding: 20px; min-height: 100vh; }
        .container { max-width: 1000px; margin: 0 auto; background-color: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); overflow: hidden; }
        header { background: linear-gradient(135deg, #2c3e50, #1a2530); color: white; padding: 25px; text-align: center; }
        .logo { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px; }
        .logo-icon { font-size: 2.5rem; color: #00c9ff; }
        h1 { font-size: 2rem; margin-bottom: 8px; }
        .subtitle { font-size: 0.95rem; opacity: 0.9; margin-bottom: 15px; }
        .browser-warning { background-color: rgba(255, 193, 7, 0.2); border: 1px solid #ffc107; border-radius: 5px; padding: 10px; margin: 15px auto; font-size: 0.85rem; max-width: 800px; display: none; }
        .main-content { padding: 25px; }
        .section { margin-bottom: 30px; }
        h2 { color: #2c3e50; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #eee; display: flex; align-items: center; gap: 10px; font-size: 1.3rem; }
        h2 i { color: #00c9ff; }
        .flash-container { text-align: center; padding: 25px; background-color: #f9f9f9; border-radius: 8px; margin-bottom: 20px; border: 2px dashed #ddd; }
        #installButton { --esp-tools-button-color: #00c9ff; --esp-tools-text-color: white; --esp-tools-border-radius: 8px; --esp-tools-font-size: 1rem; --esp-tools-padding: 15px 30px; margin: 10px 0; }
        .chip-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 20px; display: none; }
        .chip-detail { background-color: #f0f8ff; padding: 12px; border-radius: 5px; border-left: 3px solid #00c9ff; }
        .chip-detail h4 { color: #2c3e50; margin-bottom: 5px; font-size: 0.85rem; text-transform: uppercase; }
        .chip-detail p { font-weight: 600; font-size: 1rem; }
        .instructions { background-color: #f8f9fa; border-radius: 8px; padding: 20px; margin-top: 25px; }
        .instructions ol { margin-left: 20px; margin-bottom: 15px; }
        .instructions li { margin-bottom: 10px; line-height: 1.5; }
        .step-number { display: inline-block; background-color: #00c9ff; color: white; width: 22px; height: 22px; border-radius: 50%; text-align: center; line-height: 22px; margin-right: 8px; font-weight: bold; font-size: 0.9rem; }
        .warning-box { background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-top: 15px; border-radius: 0 5px 5px 0; }
        .warning-box h4 { color: #856404; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; font-size: 0.95rem; }
        .warning-box p { font-size: 0.85rem; margin-bottom: 5px; }
        .firmware-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-top: 20px; }
        .firmware-option { background-color: #f8f9fa; border-radius: 8px; padding: 18px; text-align: center; border: 2px solid #e9ecef; transition: all 0.3s; cursor: pointer; }
        .firmware-option:hover { border-color: #00c9ff; transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0, 201, 255, 0.1); }
        .firmware-option i { font-size: 2.2rem; color: #00c9ff; margin-bottom: 12px; }
        .firmware-option h3 { margin-bottom: 8px; color: #2c3e50; font-size: 1.1rem; }
        .firmware-option p { font-size: 0.85rem; color: #666; margin-bottom: 12px; }
        .btn { background-color: #00c9ff; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.3s; }
        .btn:hover { background-color: #00a8d6; }
        .custom-file-upload { display: inline-block; background-color: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-top: 10px; transition: background-color 0.3s; }
        .custom-file-upload:hover { background-color: #218838; }
        .selected-file { margin-left: 15px; font-weight: bold; color: #2c3e50; font-size: 0.9rem; }
        .status-log { background-color: #1e1e1e; color: #f0f0f0; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 0.85rem; height: 180px; overflow-y: auto; margin-top: 15px; white-space: pre-wrap; }
        .log-entry { margin-bottom: 4px; }
        .log-time { color: #6c757d; }
        .log-info { color: #17a2b8; }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-warning { color: #ffc107; }
        footer { text-align: center; padding: 20px; background-color: #f8f9fa; border-top: 1px solid #dee2e6; color: #666; font-size: 0.85rem; }
        .compatibility { display: flex; justify-content: center; gap: 15px; margin-top: 12px; flex-wrap: wrap; }
        .compatibility-item { display: flex; align-items: center; gap: 6px; }
        .compatibility-item i { color: #28a745; }
        @media (max-width: 768px) { .container { border-radius: 0; } header { padding: 20px 15px; } h1 { font-size: 1.6rem; } .main-content { padding: 20px 15px; } .firmware-options, .chip-details { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-microchip"></i></div>
                <div>
                    <h1>ESP32-S3 Web Flasher</h1>
                    <p class="subtitle">N·∫°p firmware cho ESP32-S3 tr·ª±c ti·∫øp t·ª´ tr√¨nh duy·ªát Web - Phi√™n b·∫£n ƒë√£ s·ª≠a l·ªói</p>
                </div>
            </div>
            <div class="browser-warning" id="browserWarning">
                <i class="fas fa-exclamation-triangle"></i> Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Web Serial API. Vui l√≤ng s·ª≠ d·ª•ng Chrome/Edge 89+ ho·∫∑c Opera 76+.
            </div>
        </header>
        
        <div class="main-content">
            <div class="section">
                <h2><i class="fas fa-bolt"></i> N·∫°p Firmware ESP32-S3</h2>
                <div class="flash-container">
                    <!-- N√∫t c√†i ƒë·∫∑t KH√îNG c√≥ manifest m·∫∑c ƒë·ªãnh -->
                    <esp-web-install-button id="installButton">
                        <span slot="activate">K·∫øt n·ªëi v√† n·∫°p firmware</span>
                        <span slot="unsupported">Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Serial. Vui l√≤ng d√πng Chrome/Edge.</span>
                        <span slot="not-allowed">Vui l√≤ng cho ph√©p truy c·∫≠p c·ªïng Serial.</span>
                    </esp-web-install-button>
                    
                    <div class="chip-details" id="chipDetails">
                        <div class="chip-detail"><h4>Chip</h4><p id="chipType">Ch∆∞a k·∫øt n·ªëi</p></div>
                        <div class="chip-detail"><h4>MAC Address</h4><p id="macAddress">-</p></div>
                        <div class="chip-detail"><h4>Flash Size</h4><p id="flashSize">-</p></div>
                        <div class="chip-detail"><h4>Tr·∫°ng th√°i</h4><p id="chipStatus">Ch·ªù k·∫øt n·ªëi</p></div>
                    </div>
                </div>
                
                <div class="instructions">
                    <h3><i class="fas fa-list-ol"></i> H∆∞·ªõng d·∫´n n·∫°p firmware (C√ÅCH M·ªöI)</h3>
                    <ol>
                        <li><span class="step-number">1</span> Ch·ªçn m·ªôt trong 3 firmware m·∫´u b√™n d∆∞·ªõi HO·∫∂C t·∫£i l√™n file .bin c·ªßa b·∫°n.</li>
                        <li><span class="step-number">2</span> Nh·∫•n n√∫t <strong>"K·∫øt n·ªëi v√† n·∫°p firmware"</strong> ·ªü tr√™n.</li>
                        <li><span class="step-number">3</span> Ch·ªçn c·ªïng Serial khi tr√¨nh duy·ªát h·ªèi.</li>
                        <li><span class="step-number">4</span> Qu√° tr√¨nh n·∫°p s·∫Ω t·ª± ƒë·ªông b·∫Øt ƒë·∫ßu.</li>
                    </ol>
                    
                    <div class="warning-box">
                        <h4><i class="fas fa-exclamation-triangle"></i> L∆∞u √Ω quan tr·ªçng</h4>
                        <p>‚Ä¢ <strong>KH√îNG c·∫ßn ch·ªçn file .bin l·∫ßn th·ª© hai</strong> sau khi ƒë√£ ch·ªçn firmware ·ªü b∆∞·ªõc 1.</p>
                        <p>‚Ä¢ N·∫øu d√πng file c·ªßa b·∫°n, h√£y ƒë·∫£m b·∫£o ƒë√≥ l√† file .bin h·ª£p l·ªá cho ESP32-S3.</p>
                        <p>‚Ä¢ Ch·ªâ ho·∫°t ƒë·ªông tr√™n Chrome/Edge/Opera phi√™n b·∫£n m·ªõi.</p>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-download"></i> B∆∞·ªõc 1: Ch·ªçn Firmware</h2>
                <p>Ch·ªçn firmware m·∫´u ho·∫∑c t·∫£i l√™n file c·ªßa b·∫°n:</p>
                
                <div class="firmware-options">
                    <div class="firmware-option" onclick="selectSampleFirmware('blink')">
                        <i class="fas fa-lightbulb"></i>
                        <h3>LED Blink (M·∫´u)</h3>
                        <p>Firmware nh·∫•p nh√°y LED c∆° b·∫£n</p>
                        <button class="btn">Ch·ªçn c√°i n√†y</button>
                    </div>
                    
                    <div class="firmware-option" onclick="selectSampleFirmware('webserver')">
                        <i class="fas fa-server"></i>
                        <h3>Web Server (M·∫´u)</h3>
                        <p>ESP32-S3 l√†m web server ƒë∆°n gi·∫£n</p>
                        <button class="btn">Ch·ªçn c√°i n√†y</button>
                    </div>
                    
                    <div class="firmware-option" onclick="selectSampleFirmware('wifi')">
                        <i class="fas fa-wifi"></i>
                        <h3>Wi-Fi Scanner (M·∫´u)</h3>
                        <p>Qu√©t c√°c m·∫°ng Wi-Fi xung quanh</p>
                        <button class="btn">Ch·ªçn c√°i n√†y</button>
                    </div>
                </div>
                
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;">
                    <h3><i class="fas fa-upload"></i> Ho·∫∑c d√πng firmware c·ªßa b·∫°n</h3>
                    <p>T·∫£i l√™n file firmware .bin t·ª´ m√°y t√≠nh c·ªßa b·∫°n:</p>
                    <div style="margin-top: 15px;">
                        <input type="file" id="firmwareFile" accept=".bin" style="display: none;">
                        <button onclick="document.getElementById('firmwareFile').click()" class="custom-file-upload">
                            <i class="fas fa-upload"></i> Ch·ªçn file firmware .bin c·ªßa b·∫°n
                        </button>
                        <span id="selectedFile" class="selected-file"></span>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-terminal"></i> Nh·∫≠t k√Ω & Th√¥ng b√°o l·ªói</h2>
                <div class="status-log" id="statusLog">
                    <div class="log-entry">
                        <span class="log-time">[10:30:15]</span>
                        <span class="log-info">ESP32-S3 Web Flasher (Phi√™n b·∫£n ƒë√£ s·ª≠a l·ªói URL) ƒë√£ s·∫µn s√†ng</span>
                    </div>
                    <div id="logContent"></div>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <button onclick="clearLog()" class="btn" style="background-color: #6c757d;">
                        <i class="fas fa-trash-alt"></i> X√≥a nh·∫≠t k√Ω
                    </button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>ESP32-S3 Web Flasher | S·ª≠ d·ª•ng ESP Web Tools t·ª´ Espressif Systems</p>
            <p>Phi√™n b·∫£n s·ª≠a l·ªói "Invalid URL" - Nguy√™n t·∫Øc: T·∫°o URL an to√†n, ki·ªÉm tra d·ªØ li·ªáu tr∆∞·ªõc khi d√πng</p>
            <div class="compatibility">
                <div class="compatibility-item"><i class="fab fa-chrome"></i><span>Chrome 89+</span></div>
                <div class="compatibility-item"><i class="fab fa-edge"></i><span>Edge 89+</span></div>
                <div class="compatibility-item"><i class="fab fa-opera"></i><span>Opera 76+</span></div>
            </div>
        </footer>
    </div>

    <script>
        // ========== BI·∫æN TO√ÄN C·ª§C ==========
        let currentManifestUrl = null;
        let selectedFirmwareFile = null;
        
        // ========== H√ÄM HI·ªÇN TH·ªä LOG ==========
        function addLog(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            let typeClass = 'log-info';
            if (type === 'success') typeClass = 'log-success';
            if (type === 'error') typeClass = 'log-error';
            if (type === 'warning') typeClass = 'log-warning';
            
            logEntry.innerHTML = `<span class="log-time">[${time}]</span> <span class="${typeClass}">${message}</span>`;
            logContent.appendChild(logEntry);
            document.getElementById('statusLog').scrollTop = document.getElementById('statusLog').scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('logContent').innerHTML = '';
            addLog('ƒê√£ x√≥a nh·∫≠t k√Ω');
        }
        
        // ========== H√ÄM KI·ªÇM TRA TR√åNH DUY·ªÜT ==========
        function checkBrowserSupport() {
            if (!('serial' in navigator)) {
                document.getElementById('browserWarning').style.display = 'block';
                addLog('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Serial API', 'error');
                return false;
            }
            addLog('Tr√¨nh duy·ªát h·ªó tr·ª£ Web Serial API', 'success');
            return true;
        }
        
        // ========== H√ÄM T·∫†O MANIFEST T·ª™ FILE ==========
        // H√ÄM QUAN TR·ªåNG: T·∫°o manifest an to√†n, ki·ªÉm tra file tr∆∞·ªõc khi t·∫°o URL
        function createManifestFromFile(file) {
            if (!file || !(file instanceof File)) {
                addLog('L·ªñI: File kh√¥ng h·ª£p l·ªá', 'error');
                return null;
            }
            
            addLog(`ƒêang t·∫°o manifest cho file: ${file.name}`, 'info');
            
            // T·∫°o object URL cho file firmware AN TO√ÄN
            const firmwareUrl = URL.createObjectURL(file);
            addLog(`ƒê√£ t·∫°o URL an to√†n cho file firmware`, 'success');
            
            // T·∫°o manifest object
            const manifest = {
                name: file.name.replace('.bin', '') || 'Firmware ESP32-S3',
                version: "1.0.0",
                builds: [
                    {
                        chipFamily: "ESP32-S3",
                        parts: [
                            { path: firmwareUrl, offset: 0x00000 } // S·ª≠ d·ª•ng object URL tr·ª±c ti·∫øp
                        ]
                    }
                ]
            };
            
            // Chuy·ªÉn manifest th√†nh blob v√† t·∫°o URL
            const manifestBlob = new Blob([JSON.stringify(manifest, null, 2)], { 
                type: 'application/json' 
            });
            
            const manifestUrl = URL.createObjectURL(manifestBlob);
            addLog('ƒê√£ t·∫°o manifest th√†nh c√¥ng', 'success');
            
            return { manifestUrl, firmwareUrl };
        }
        
        // ========== H√ÄM CH·ªåN FIRMWARE M·∫™U ==========
        function selectSampleFirmware(type) {
            let manifestUrl, description;
            
            // S·ª≠ d·ª•ng c√°c manifest m·∫´u ƒê∆†N GI·∫¢N t·ª´ CDN
            const baseUrl = 'https://raw.githubusercontent.com/espressif/esp-web-tools/main/examples';
            
            switch(type) {
                case 'blink':
                    manifestUrl = `${baseUrl}/esp32-blink/manifest.json`;
                    description = 'Firmware Blink LED m·∫´u';
                    break;
                case 'webserver':
                    // D√πng blink thay th·∫ø v√¨ webserver c√≥ th·ªÉ kh√¥ng t·ªìn t·∫°i
                    manifestUrl = `${baseUrl}/esp32-blink/manifest.json`;
                    description = 'Firmware Web Server m·∫´u (d√πng blink thay th·∫ø)';
                    break;
                case 'wifi':
                    manifestUrl = `${baseUrl}/esp32-blink/manifest.json`;
                    description = 'Firmware Wi-Fi Scanner m·∫´u (d√πng blink thay th·∫ø)';
                    break;
                default:
                    addLog('L·ªói: Lo·∫°i firmware kh√¥ng h·ª£p l·ªá', 'error');
                    return;
            }
            
            // Gi·∫£i ph√≥ng URL c≈© n·∫øu c√≥
            if (currentManifestUrl) {
                URL.revokeObjectURL(currentManifestUrl);
            }
            
            currentManifestUrl = manifestUrl;
            selectedFirmwareFile = null;
            
            // C·∫≠p nh·∫≠t n√∫t c√†i ƒë·∫∑t
            const installButton = document.getElementById('installButton');
            installButton.setAttribute('manifest', manifestUrl);
            
            document.getElementById('selectedFile').textContent = `ƒê√£ ch·ªçn: ${description}`;
            document.getElementById('selectedFile').style.color = '#00c9ff';
            
            addLog(`ƒê√£ ch·ªçn ${description}`, 'success');
            addLog('Nh·∫•n "K·∫øt n·ªëi v√† n·∫°p firmware" ƒë·ªÉ b·∫Øt ƒë·∫ßu', 'info');
        }
        
        // ========== X·ª¨ L√ù KHI NG∆Ø·ªúI D√ôNG CH·ªåN FILE ==========
        document.getElementById('firmwareFile').addEventListener('change', function(e) {
            if (e.target.files.length === 0) return;
            
            const file = e.target.files[0];
            if (!file.name.toLowerCase().endsWith('.bin')) {
                addLog('L·ªñI: Vui l√≤ng ch·ªçn file c√≥ ƒëu√¥i .bin', 'error');
                return;
            }
            
            document.getElementById('selectedFile').textContent = `ƒê√£ ch·ªçn: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            document.getElementById('selectedFile').style.color = '#28a745';
            
            addLog(`ƒê√£ ch·ªçn file: ${file.name}`, 'success');
            
            // T·∫°o manifest t·ª´ file
            const urls = createManifestFromFile(file);
            if (!urls) {
                addLog('Kh√¥ng th·ªÉ t·∫°o manifest t·ª´ file', 'error');
                return;
            }
            
            // Gi·∫£i ph√≥ng URL c≈© n·∫øu c√≥
            if (currentManifestUrl) {
                URL.revokeObjectURL(currentManifestUrl);
            }
            
            currentManifestUrl = urls.manifestUrl;
            selectedFirmwareFile = file;
            
            // C·∫≠p nh·∫≠t n√∫t c√†i ƒë·∫∑t
            const installButton = document.getElementById('installButton');
            installButton.setAttribute('manifest', urls.manifestUrl);
            
            addLog('Firmware ƒë√£ s·∫µn s√†ng. Nh·∫•n "K·∫øt n·ªëi v√† n·∫°p firmware" ƒë·ªÉ b·∫Øt ƒë·∫ßu n·∫°p.', 'info');
        });
        
        // ========== THEO D√ïI S·ª∞ KI·ªÜN ESP-WEB-INSTALL-BUTTON ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Ki·ªÉm tra tr√¨nh duy·ªát
            checkBrowserSupport();
            
            // L·∫•y tham chi·∫øu ƒë·∫øn c√°c ph·∫ßn t·ª≠
            const installButton = document.getElementById('installButton');
            const chipDetails = document.getElementById('chipDetails');
            
            // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi tr·∫°ng th√°i
            installButton.addEventListener('state-changed', function(event) {
                const state = event.detail.state;
                const statusElement = document.getElementById('chipStatus');
                
                switch(state) {
                    case 'idle':
                        addLog('S·∫µn s√†ng k·∫øt n·ªëi', 'info');
                        chipDetails.style.display = 'none';
                        break;
                    case 'installing':
                        addLog('ƒêang n·∫°p firmware...', 'info');
                        chipDetails.style.display = 'grid';
                        statusElement.textContent = 'ƒêang n·∫°p...';
                        statusElement.style.color = '#ffc107';
                        break;
                    case 'installed':
                        addLog('‚úÖ N·∫°p firmware th√†nh c√¥ng!', 'success');
                        statusElement.textContent = 'Ho√†n th√†nh';
                        statusElement.style.color = '#28a745';
                        
                        // GI·∫¢I PH√ìNG B·ªò NH·ªö: X√≥a c√°c URL ƒë√£ t·∫°o
                        if (currentManifestUrl) {
                            URL.revokeObjectURL(currentManifestUrl);
                            currentManifestUrl = null;
                        }
                        break;
                    case 'error':
                        addLog('‚ùå L·ªói khi n·∫°p firmware', 'error');
                        statusElement.textContent = 'L·ªói';
                        statusElement.style.color = '#dc3545';
                        break;
                }
            });
            
            // Hi·ªÉn th·ªã th√¥ng tin khi k·∫øt n·ªëi thi·∫øt b·ªã
            installButton.addEventListener('device-connected', function(event) {
                addLog('üì± ƒê√£ k·∫øt n·ªëi v·ªõi ESP32-S3', 'success');
                document.getElementById('chipStatus').textContent = 'ƒê√£ k·∫øt n·ªëi';
                document.getElementById('chipStatus').style.color = '#28a745';
            });
            
            // Log khi manifest ƒë∆∞·ª£c t·∫£i
            installButton.addEventListener('manifest-loaded', function(event) {
                addLog('üìÑ ƒê√£ t·∫£i th√¥ng tin firmware th√†nh c√¥ng', 'success');
            });
        });
        
        // ========== KH·ªûI T·∫†O BAN ƒê·∫¶U ==========
        setTimeout(() => {
            addLog('Trang web ƒë√£ s·∫µn s√†ng. Vui l√≤ng ch·ªçn firmware ·ªü B∆∞·ªõc 1.', 'success');
            addLog('Phi√™n b·∫£n n√†y ƒë√£ s·ª≠a l·ªói "Invalid URL"', 'info');
        }, 500);
    </script>
</body>
</html>