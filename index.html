<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng C·ª• N·∫°p ESP32-S3 - Phi√™n b·∫£n T√≠ch h·ª£p Repo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="https://unpkg.com/esp-web-tools@9/dist/web/install-button.js?module"></script>
    <style>
        :root { --primary: #00c9ff; --success: #28a745; --danger: #dc3545; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8f9fa; color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); overflow: hidden; }
        header { background: linear-gradient(135deg, #2c3e50, #1a2530); color: white; padding: 25px; text-align: center; }
        h1 { font-size: 1.8rem; margin-bottom: 5px; }
        .subtitle { font-size: 0.9rem; opacity: 0.9; }
        .main-content { padding: 25px; }
        .section { margin-bottom: 30px; }
        h2 { color: #2c3e50; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #eee; display: flex; align-items: center; gap: 10px; font-size: 1.2rem; }
        .method-card { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #dee2e6; }
        
        /* CSS cho n√∫t c√†i ƒë·∫∑t ch√≠nh - ƒê√É C·∫¨P NH·∫¨T */
        #installButton {
            --esp-tools-button-color: #00c9ff; /* M√†u xanh ch√≠nh */
            --esp-tools-button-hover-color: #00a8d6; /* M√†u khi hover (xanh ƒë·∫≠m h∆°n) */
            --esp-tools-border-radius: 8px;
            --esp-tools-font-size: 1rem;
            --esp-tools-padding: 12px 24px;
            width: 100%;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        
        #installButton::part(button) {
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 201, 255, 0.2);
            border: none;
            cursor: pointer;
        }
        
        #installButton::part(button):hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 201, 255, 0.3);
        }
        
        #installButton::part(button):active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 201, 255, 0.2);
        }
        
        .input-group { margin-top: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #495057; }
        input[type="url"], input[type="text"] { width: 100%; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 5px; font-size: 0.95rem; transition: border-color 0.3s; }
        input:focus { border-color: var(--primary); outline: none; }
        .btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-align: center; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #00a8d6; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover { background-color: #218838; }
        .status-log { background-color: #1a1a1a; color: #e0e0e0; padding: 15px; border-radius: 5px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85rem; height: 250px; overflow-y: auto; margin-top: 20px; white-space: pre-wrap; }
        .log-entry { margin-bottom: 5px; line-height: 1.4; }
        .log-time { color: #6c757d; }
        .log-info { color: #17a2b8; }
        .log-success { color: var(--success); }
        .log-error { color: var(--danger); }
        .log-warning { color: #ffc107; }
        footer { text-align: center; padding: 20px; color: #6c757d; font-size: 0.85rem; border-top: 1px solid #eee; }
        .hidden { display: none; }
        .url-hint { font-size: 0.8rem; color: #6c757d; margin-top: 5px; }
        #githubUrl { font-family: monospace; }
        .button-group { display: flex; gap: 10px; margin-top: 10px; }
        .button-group .btn { flex: 1; }
        .default-firmware-info { background-color: #e7f3ff; border-left: 4px solid var(--primary); padding: 10px; margin-top: 10px; border-radius: 0 4px 4px 0; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-microchip"></i> ESP32-S3 Web Flasher</h1>
            <p class="subtitle">N·∫°p t·ª´ file m√°y t√≠nh ho·∫∑c firmware m·∫∑c ƒë·ªãnh c·ªßa d·ª± √°n</p>
        </header>
        <div class="main-content">
            <!-- Ph·∫ßn 1: N·∫†P T·ª™ FILE TR√äN M√ÅY -->
            <div class="section">
                <h2><i class="fas fa-upload"></i> 1. N·∫°p t·ª´ file tr√™n m√°y</h2>
                <div class="method-card">
                    <p>Ch·ªçn file firmware <code>.bin</code> t·ª´ m√°y t√≠nh c·ªßa b·∫°n n·∫øu b·∫°n c√≥ phi√™n b·∫£n t√πy ch·ªânh.</p>
                    <div class="input-group">
                        <input type="file" id="localFile" accept=".bin" style="display: none;">
                        <button onclick="document.getElementById('localFile').click()" class="btn btn-secondary">
                            <i class="fas fa-folder-open"></i> Ch·ªçn file .bin
                        </button>
                        <span id="localFileName" style="margin-left: 15px; font-weight:500;"></span>
                    </div>
                </div>
            </div>

            <!-- Ph·∫ßn 2: N·∫†P FIRMWARE M·∫∂C ƒê·ªäNH (T·ª´ ch√≠nh repo n√†y) -->
            <div class="section">
                <h2><i class="fas fa-cloud-download-alt"></i> 2. N·∫°p firmware m·∫∑c ƒë·ªãnh c·ªßa d·ª± √°n</h2>
                <div class="method-card">
                    <p>Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ s·ª≠ d·ª•ng phi√™n b·∫£n firmware ch√≠nh th·ª©c m·ªõi nh·∫•t ƒë∆∞·ª£c l∆∞u tr·ªØ ngay trong kho n√†y.</p>
                    <div class="default-firmware-info">
                        <strong><i class="fas fa-info-circle"></i> Th√¥ng tin phi√™n b·∫£n hi·ªán t·∫°i:</strong>
                        <div id="firmwareVersionInfo">ƒêang ki·ªÉm tra...</div>
                    </div>
                    <div class="button-group">
                        <button onclick="loadDefaultFirmware()" class="btn btn-success" id="defaultFirmwareBtn">
                            <i class="fas fa-bolt"></i> S·ª≠ d·ª•ng firmware m·∫∑c ƒë·ªãnh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ph·∫ßn 3: B·∫ÆT ƒê·∫¶U N·∫†P V√ÄO THI·∫æT B·ªä - N√öT CH√çNH -->
            <div class="section">
                <h2><i class="fas fa-play-circle"></i> 3. B·∫Øt ƒë·∫ßu n·∫°p v√†o thi·∫øt b·ªã</h2>
                <div class="method-card">
                    <p><strong>B∆∞·ªõc cu·ªëi c√πng:</strong> Sau khi ch·ªçn firmware ·ªü tr√™n, nh·∫•n n√∫t <span style="color:#00c9ff;font-weight:bold;">m√†u xanh</span> b√™n d∆∞·ªõi ƒë·ªÉ k·∫øt n·ªëi v·ªõi ESP32-S3 v√† b·∫Øt ƒë·∫ßu qu√° tr√¨nh n·∫°p.</p>
                    
                    <!-- N√öT CH√çNH V·ªöI HI·ªÜU ·ª®NG HOVER -->
                    <esp-web-install-button id="installButton">
                        <span slot="activate"><i class="fas fa-plug"></i> K·∫øt n·ªëi ESP32-S3 & B·∫Øt ƒë·∫ßu n·∫°p</span>
                        <span slot="unsupported">Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£. Vui l√≤ng d√πng Chrome/Edge.</span>
                        <span slot="not-allowed">ƒê√£ t·ª´ ch·ªëi truy c·∫≠p c·ªïng Serial. H√£y th·ª≠ l·∫°i.</span>
                    </esp-web-install-button>
                    
                    <p class="url-hint" style="margin-top: 10px;">
                        <i class="fas fa-mouse-pointer"></i> <strong>Di chu·ªôt qua n√∫t ƒë·ªÉ xem hi·ªáu ·ª©ng!</strong>
                    </p>
                </div>
            </div>

            <!-- Ph·∫ßn 4: LOG H·ªÜ TH·ªêNG -->
            <div class="section">
                <h2><i class="fas fa-terminal"></i> Nh·∫≠t k√Ω h·ªá th·ªëng</h2>
                <div class="status-log" id="statusLog">
                    <div class="log-entry log-info">[H·ªá th·ªëng] C√¥ng c·ª• ƒë√£ s·∫µn s√†ng. Vui l√≤ng ch·ªçn ngu·ªìn firmware.</div>
                </div>
                <div style="text-align: right; margin-top:10px;">
                    <button onclick="clearLog()" class="btn btn-secondary btn-sm"><i class="fas fa-trash"></i> X√≥a log</button>
                </div>
            </div>
        </div>
        <footer>
            <p>ESP Web Flasher | Phi√™n b·∫£n t√≠ch h·ª£p Repository | D·ª±a tr√™n ESP Web Tools</p>
        </footer>
    </div>

    <script>
        // ========== C·∫§U H√åNH ·∫®N QUAN TR·ªåNG ==========
        const DEFAULT_FIRMWARE_RAW_URL = 'https://raw.githubusercontent.com/vnthao/nap/main/firmware/xiaozhi_Thao-merged-binary.bin';

        // ========== BI·∫æN TO√ÄN C·ª§C ==========
        let currentManifestObject = null;

        // ========== H√ÄM LOG ==========
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('statusLog');
            const time = new Date().toLocaleTimeString('vi-VN', { hour12: false });
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            const typeClassMap = { 'info': 'log-info', 'success': 'log-success', 'error': 'log-error', 'warning': 'log-warning' };
            logEntry.innerHTML = `<span class="log-time">[${time}]</span> <span class="${typeClassMap[type] || 'log-info'}">${message}</span>`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('statusLog').innerHTML = '';
            addLog('ƒê√£ x√≥a nh·∫≠t k√Ω.', 'info');
        }

        // ========== PH·∫¶N 1: X·ª¨ L√ù FILE LOCAL ==========
        document.getElementById('localFile').addEventListener('change', async function(e) {
            if (!e.target.files.length) return;
            const file = e.target.files[0];
            const fileNameEl = document.getElementById('localFileName');

            if (!file.name.toLowerCase().endsWith('.bin')) {
                addLog(`‚ùå File "${file.name}" kh√¥ng ph·∫£i file .bin h·ª£p l·ªá.`, 'error');
                fileNameEl.textContent = 'File kh√¥ng h·ª£p l·ªá!';
                fileNameEl.style.color = 'var(--danger)';
                return;
            }

            fileNameEl.textContent = `üìÑ ${file.name} (${(file.size / (1024*1024)).toFixed(2)} MB)`;
            fileNameEl.style.color = 'var(--success)';
            addLog(`ƒê√£ ch·ªçn file: "${file.name}"`, 'success');

            const fileObjectUrl = URL.createObjectURL(file);
            const manifest = {
                name: `Local: ${file.name}`,
                version: "1.0.0",
                builds: [{ chipFamily: "ESP32-S3", parts: [{ path: fileObjectUrl, offset: 0x00000 }] }]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);

            updateInstallButton(manifestUrl);
            currentManifestObject = { manifestUrl, fileObjectUrl };
            addLog('‚úÖ Firmware ƒë√£ s·∫µn s√†ng. B·∫•m n√∫t <span style="color:#00c9ff">"K·∫øt n·ªëi ESP32-S3 & B·∫Øt ƒë·∫ßu n·∫°p"</span> ƒë·ªÉ ti·∫øp t·ª•c.', 'info');
        });

        // ========== PH·∫¶N 2: FIRMWARE M·∫∂C ƒê·ªäNH T·ª™ REPO ==========
        async function loadDefaultFirmware() {
            const btn = document.getElementById('defaultFirmwareBtn');
            const infoDiv = document.getElementById('firmwareVersionInfo');

            if (!DEFAULT_FIRMWARE_RAW_URL || DEFAULT_FIRMWARE_RAW_URL === 'YOUR_RAW_FIRMWARE_URL_HERE') {
                addLog('‚ùå Ch∆∞a c·∫•u h√¨nh URL firmware m·∫∑c ƒë·ªãnh.', 'error');
                infoDiv.innerHTML = `<span style="color:var(--danger);">Ch∆∞a c·∫•u h√¨nh URL. Vui l√≤ng ch·ªânh s·ª≠a file index.html.</span>`;
                alert('L·ªói: Ch∆∞a c·∫•u h√¨nh URL firmware m·∫∑c ƒë·ªãnh.\n\nVui l√≤ng thay th·∫ø bi·∫øn DEFAULT_FIRMWARE_RAW_URL trong code b·∫±ng Raw URL c·ªßa b·∫°n.');
                return;
            }

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang ki·ªÉm tra...';
            btn.disabled = true;
            infoDiv.innerHTML = `ƒêang ki·ªÉm tra...`;

            addLog(`üîç ƒêang ki·ªÉm tra firmware m·∫∑c ƒë·ªãnh t·∫°i: ${DEFAULT_FIRMWARE_RAW_URL}`, 'info');

            try {
                const testResponse = await fetch(DEFAULT_FIRMWARE_RAW_URL, { method: 'HEAD' });
                if (!testResponse.ok) throw new Error(`HTTP ${testResponse.status}`);

                const fileSize = testResponse.headers.get('content-length');
                const sizeText = fileSize ? ` (${(fileSize / (1024*1024)).toFixed(2)} MB)` : '';

                const manifest = {
                    name: `Firmware ch√≠nh th·ª©c`,
                    version: "1.0",
                    builds: [{
                        chipFamily: "ESP32-S3",
                        parts: [{ path: DEFAULT_FIRMWARE_RAW_URL, offset: 0x00000 }]
                    }]
                };

                const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                const manifestUrl = URL.createObjectURL(manifestBlob);

                updateInstallButton(manifestUrl);
                currentManifestObject = { manifestUrl };

                infoDiv.innerHTML = `
                    <span style="color:var(--success);">
                        <i class="fas fa-check-circle"></i> Phi√™n b·∫£n m·ªõi nh·∫•t ƒë√£ s·∫µn s√†ng.
                    </span><br>
                    <small>URL: ${new URL(DEFAULT_FIRMWARE_RAW_URL).pathname.split('/').pop()} ${sizeText}</small>
                `;
                document.getElementById('localFileName').textContent = '';

                addLog(`‚úÖ ƒê√£ thi·∫øt l·∫≠p firmware m·∫∑c ƒë·ªãnh th√†nh c√¥ng!`, 'success');
                addLog('üëâ B·∫•m n√∫t <span style="color:#00c9ff">"K·∫øt n·ªëi ESP32-S3 & B·∫Øt ƒë·∫ßu n·∫°p"</span> ƒë·ªÉ b·∫Øt ƒë·∫ßu n·∫°p.', 'info');

            } catch (error) {
                addLog(`‚ùå Kh√¥ng th·ªÉ t·∫£i firmware m·∫∑c ƒë·ªãnh: ${error.message}`, 'error');
                infoDiv.innerHTML = `<span style="color:var(--danger);"><i class="fas fa-exclamation-triangle"></i> Kh√¥ng th·ªÉ t·∫£i file. Ki·ªÉm tra URL ho·∫∑c k·∫øt n·ªëi m·∫°ng.</span>`;
                alert(`Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn file firmware m·∫∑c ƒë·ªãnh.\n\nL·ªói: ${error.message}\n\nH√£y ƒë·∫£m b·∫£o:\n1. URL '${DEFAULT_FIRMWARE_RAW_URL}' l√† ƒë√∫ng.\n2. File ƒë√£ ƒë∆∞·ª£c upload v√† c√¥ng khai tr√™n GitHub.\n3. B·∫°n ƒëang s·ª≠ d·ª•ng "Raw URL".`);
            } finally {
                btn.innerHTML = '<i class="fas fa-bolt"></i> S·ª≠ d·ª•ng firmware m·∫∑c ƒë·ªãnh';
                btn.disabled = false;
            }
        }

        // ========== C·∫¨P NH·∫¨T N√öT C√ÄI ƒê·∫∂T ==========
        const installButton = document.getElementById('installButton');

        function updateInstallButton(manifestUrl) {
            if (installButton.hasAttribute('manifest')) installButton.removeAttribute('manifest');
            setTimeout(() => installButton.setAttribute('manifest', manifestUrl), 50);
        }

        // ========== L·∫ÆNG NGHE S·ª∞ KI·ªÜN TH·ª∞C T·∫æ ==========
        installButton.addEventListener('state-changed', (event) => {
            const state = event.detail.state;
            switch (state) {
                case 'idle': addLog('[Tr·∫°ng th√°i] S·∫µn s√†ng.', 'info'); break;
                case 'installing': addLog('[Tr·∫°ng th√°i] üî• ƒêang n·∫°p firmware v√†o ESP32-S3... Vui l√≤ng kh√¥ng ng·∫Øt k·∫øt n·ªëi.', 'warning'); break;
                case 'installed': addLog('[Tr·∫°ng th√°i] ‚úÖ N·∫°p firmware HO√ÄN T·∫§T! Thi·∫øt b·ªã s·∫Ω t·ª± ƒë·ªông kh·ªüi ƒë·ªông l·∫°i.', 'success'); cleanupObjectUrls(); break;
                case 'error': addLog(`[Tr·∫°ng th√°i] ‚ùå L·ªói: ${event.detail.message || 'Nguy√™n nh√¢n kh√¥ng x√°c ƒë·ªãnh.'}`, 'error'); break;
            }
        });
        
        installButton.addEventListener('device-connected', () => addLog('[Thi·∫øt b·ªã] üìç ƒê√£ k·∫øt n·ªëi v·ªõi ESP32-S3.', 'success'));
        installButton.addEventListener('manifest-loaded', () => addLog('[Firmware] ‚úÖ ƒê√£ x√°c th·ª±c th√¥ng tin firmware.', 'info'));

        // ========== D·ªåN D·∫∏P B·ªò NH·ªö ==========
        function cleanupObjectUrls() {
            if (currentManifestObject) {
                URL.revokeObjectURL(currentManifestObject.manifestUrl);
                if (currentManifestObject.fileObjectUrl) URL.revokeObjectURL(currentManifestObject.fileObjectUrl);
                currentManifestObject = null;
                addLog('[H·ªá th·ªëng] ƒê√£ d·ªçn d·∫πp b·ªô nh·ªõ t·∫°m.', 'info');
            }
        }

        // ========== KH·ªûI T·∫†O ==========
        window.onload = function() {
            addLog('[H·ªá th·ªëng] C√¥ng c·ª• n·∫°p ESP32-S3 ƒë√£ kh·ªüi ƒë·ªông.', 'info');
            addLog('[H∆∞·ªõng d·∫´n] Ch·ªçn "N·∫°p t·ª´ file tr√™n m√°y" HO·∫∂C nh·∫•n "S·ª≠ d·ª•ng firmware m·∫∑c ƒë·ªãnh".', 'info');

            if (DEFAULT_FIRMWARE_RAW_URL && DEFAULT_FIRMWARE_RAW_URL !== 'YOUR_RAW_FIRMWARE_URL_HERE') {
                addLog('[H·ªá th·ªëng] ƒêang t·∫£i th√¥ng tin firmware m·∫∑c ƒë·ªãnh...', 'info');
                setTimeout(loadDefaultFirmware, 1000);
            } else {
                addLog('[C·∫£nh b√°o] URL firmware m·∫∑c ƒë·ªãnh ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh.', 'warning');
            }
        };
    </script>
</body>
</html>
