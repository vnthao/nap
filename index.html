<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng C·ª• N·∫°p ESP32-S3</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="https://unpkg.com/esp-web-tools@9/dist/web/install-button.js?module"></script>
    <style>
        :root { --primary: #00c9ff; --success: #28a745; --danger: #dc3545; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8f9fa; color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); overflow: hidden; }
        header { background: linear-gradient(135deg, #2c3e50, #1a2530); color: white; padding: 25px; text-align: center; }
        h1 { font-size: 1.8rem; margin-bottom: 5px; }
        .subtitle { font-size: 0.9rem; opacity: 0.9; }
        .main-content { padding: 25px; }
        .section { margin-bottom: 30px; }
        h2 { color: #2c3e50; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #eee; display: flex; align-items: center; gap: 10px; font-size: 1.2rem; }
        .method-card { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #dee2e6; }
        .input-group { margin-top: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #495057; }
        input[type="url"], input[type="text"] { width: 100%; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 5px; font-size: 0.95rem; transition: border-color 0.3s; }
        input:focus { border-color: var(--primary); outline: none; }
        .btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-align: center; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #00a8d6; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        #installButton { --esp-tools-button-color: var(--primary); --esp-tools-border-radius: 8px; width: 100%; margin-top: 15px; }
        .status-log { background-color: #1a1a1a; color: #e0e0e0; padding: 15px; border-radius: 5px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85rem; height: 250px; overflow-y: auto; margin-top: 20px; white-space: pre-wrap; }
        .log-entry { margin-bottom: 5px; line-height: 1.4; }
        .log-time { color: #6c757d; }
        .log-info { color: #17a2b8; }
        .log-success { color: var(--success); }
        .log-error { color: var(--danger); }
        .log-warning { color: #ffc107; }
        footer { text-align: center; padding: 20px; color: #6c757d; font-size: 0.85rem; border-top: 1px solid #eee; }
        .hidden { display: none; }
        .url-hint { font-size: 0.8rem; color: #6c757d; margin-top: 5px; }
        #githubUrl { font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-microchip"></i> C√¥ng C·ª• N·∫°p ESP32-S3</h1>
            <p class="subtitle">N·∫°p firmware tr·ª±c ti·∫øp t·ª´ tr√¨nh duy·ªát ho·∫∑c t·ª´ li√™n k·∫øt tr·ª±c tuy·∫øn</p>
        </header>
        <div class="main-content">
            <!-- Ph·∫ßn 1: N·∫†P T·ª™ FILE TR√äN M√ÅY -->
            <div class="section">
                <h2><i class="fas fa-upload"></i> 1. N·∫°p t·ª´ file tr√™n m√°y</h2>
                <div class="method-card">
                    <p>Ch·ªçn file firmware <code>.bin</code> t·ª´ m√°y t√≠nh c·ªßa b·∫°n.</p>
                    <div class="input-group">
                        <input type="file" id="localFile" accept=".bin" style="display: none;">
                        <button onclick="document.getElementById('localFile').click()" class="btn btn-secondary">
                            <i class="fas fa-folder-open"></i> Ch·ªçn file .bin
                        </button>
                        <span id="localFileName" style="margin-left: 15px; font-weight:500;"></span>
                    </div>
                </div>
            </div>

            <!-- Ph·∫ßn 2: N·∫†P T·ª™ LINK GITHUB (T√çNH NƒÇNG M·ªöI) -->
            <div class="section">
                <h2><i class="fab fa-github"></i> 2. N·∫°p t·ª´ li√™n k·∫øt GitHub (Online)</h2>
                <div class="method-card">
                    <p>D√°n URL tr·ª±c ti·∫øp ƒë·∫øn file <code>.bin</code> tr√™n GitHub (ho·∫∑c b·∫•t k·ª≥ m√°y ch·ªß n√†o).</p>
                    <div class="input-group">
                        <label for="githubUrl">URL file firmware:</label>
                        <input type="url" id="githubUrl" placeholder="https://github.com/user/repo/raw/main/firmware.bin">
                        <p class="url-hint">üìù <strong>M·∫πo:</strong> Tr√™n GitHub, nh·∫•n v√†o file .bin, ch·ªçn "Raw", sau ƒë√≥ sao ch√©p URL t·ª´ thanh ƒë·ªãa ch·ªâ.</p>
                    </div>
                    <button onclick="loadFromGitHub()" class="btn btn-primary">
                        <i class="fas fa-download"></i> T·∫£i & Thi·∫øt l·∫≠p firmware t·ª´ URL n√†y
                    </button>
                </div>
            </div>

            <!-- Ph·∫ßn 3: N√öT B·∫ÆT ƒê·∫¶U N·∫†P -->
            <div class="section">
                <h2><i class="fas fa-play-circle"></i> 3. B·∫Øt ƒë·∫ßu n·∫°p v√†o thi·∫øt b·ªã</h2>
                <div class="method-card">
                    <p>Sau khi ch·ªçn firmware ·ªü tr√™n, nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ k·∫øt n·ªëi v·ªõi ESP32-S3 v√† b·∫Øt ƒë·∫ßu qu√° tr√¨nh n·∫°p.</p>
                    <!-- N√∫t ch√≠nh c·ªßa esp-web-tools -->
                    <esp-web-install-button id="installButton">
                        <span slot="activate"><i class="fas fa-plug"></i> K·∫øt n·ªëi ESP32-S3 & B·∫Øt ƒë·∫ßu n·∫°p</span>
                        <span slot="unsupported">Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£. Vui l√≤ng d√πng Chrome/Edge.</span>
                        <span slot="not-allowed">ƒê√£ t·ª´ ch·ªëi truy c·∫≠p c·ªïng Serial. H√£y th·ª≠ l·∫°i.</span>
                    </esp-web-install-button>
                </div>
            </div>

            <!-- Ph·∫ßn 4: LOG H·ªÜ TH·ªêNG -->
            <div class="section">
                <h2><i class="fas fa-terminal"></i> Nh·∫≠t k√Ω h·ªá th·ªëng</h2>
                <div class="status-log" id="statusLog">
                    <!-- Log s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·ªüi JavaScript -->
                    <div class="log-entry log-info">[H·ªá th·ªëng] C√¥ng c·ª• ƒë√£ s·∫µn s√†ng. Ch·ªçn firmware v√† b·∫Øt ƒë·∫ßu.</div>
                </div>
                <div style="text-align: right; margin-top:10px;">
                    <button onclick="clearLog()" class="btn btn-secondary btn-sm"><i class="fas fa-trash"></i> X√≥a log</button>
                </div>
            </div>
        </div>
        <footer>
            <p>ESP Web Flasher | D·ª±a tr√™n ESP Web Tools c·ªßa Espressif | Phi√™n b·∫£n: Chuy√™n d·ª•ng</p>
        </footer>
    </div>

    <script>
        // ========== BI·∫æN TO√ÄN C·ª§C & H√ÄM LOG ==========
        let currentManifestObject = null;

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('statusLog');
            const time = new Date().toLocaleTimeString('vi-VN', { hour12: false });
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';

            // Map lo·∫°i log sang class CSS
            const typeClassMap = { 'info': 'log-info', 'success': 'log-success', 'error': 'log-error', 'warning': 'log-warning' };
            logEntry.innerHTML = `<span class="log-time">[${time}]</span> <span class="${typeClassMap[type] || 'log-info'}">${message}</span>`;
            logContainer.appendChild(logEntry);
            // T·ª± ƒë·ªông cu·ªôn xu·ªëng d√≤ng m·ªõi nh·∫•t
            logContainer.scrollTop = logContainer.scrollHeight;
            // In ra console ƒë·ªÉ debug
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('statusLog').innerHTML = '';
            addLog('ƒê√£ x√≥a nh·∫≠t k√Ω.', 'info');
        }

        // ========== PH·∫¶N 1: X·ª¨ L√ù FILE LOCAL ==========
        document.getElementById('localFile').addEventListener('change', function(e) {
            if (!e.target.files.length) return;
            const file = e.target.files[0];
            const fileNameEl = document.getElementById('localFileName');

            if (!file.name.toLowerCase().endsWith('.bin')) {
                addLog(`L·ªói: File "${file.name}" kh√¥ng ph·∫£i l√† file .bin h·ª£p l·ªá.`, 'error');
                fileNameEl.textContent = 'File kh√¥ng h·ª£p l·ªá!';
                fileNameEl.style.color = 'var(--danger)';
                return;
            }

            fileNameEl.textContent = `üìÑ ${file.name} (${(file.size / (1024*1024)).toFixed(2)} MB)`;
            fileNameEl.style.color = 'var(--success)';
            addLog(`ƒê√£ ch·ªçn file local: "${file.name}"`, 'success');

            // T·∫°o Object URL cho file (an to√†n v·ªõi tr√¨nh duy·ªát)
            const fileObjectUrl = URL.createObjectURL(file);
            // T·∫°o manifest JSON cho file n√†y
            const manifest = {
                name: `Local: ${file.name}`,
                version: "1.0.0",
                builds: [{ chipFamily: "ESP32-S3", parts: [{ path: fileObjectUrl, offset: 0x00000 }] }]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);

            // C·∫≠p nh·∫≠t n√∫t c√†i ƒë·∫∑t
            updateInstallButton(manifestUrl);
            // L∆∞u ƒë·ªëi t∆∞·ª£ng ƒë·ªÉ d·ªçn d·∫πp sau
            currentManifestObject = { manifestUrl, fileObjectUrl };
            addLog('Firmware ƒë√£ s·∫µn s√†ng. B·∫•m "K·∫øt n·ªëi..." ƒë·ªÉ n·∫°p.', 'info');
        });

        // ========== PH·∫¶N 2: X·ª¨ L√ù URL GITHUB (T√çNH NƒÇNG CH√çNH) ==========
        async function loadFromGitHub() {
            const urlInput = document.getElementById('githubUrl').value.trim();
            const fileNameEl = document.getElementById('localFileName');

            if (!urlInput) {
                addLog('L·ªói: Vui l√≤ng nh·∫≠p URL file firmware.', 'error');
                alert('Vui l√≤ng d√°n URL file .bin v√†o √¥ b√™n tr√™n.');
                return;
            }

            // Ki·ªÉm tra URL h·ª£p l·ªá c∆° b·∫£n
            try {
                new URL(urlInput);
            } catch {
                addLog(`L·ªói: URL kh√¥ng h·ª£p l·ªá: "${urlInput}"`, 'error');
                alert('URL kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng. Vui l√≤ng ki·ªÉm tra l·∫°i.');
                return;
            }

            addLog(`ƒêang t·∫£i firmware t·ª´: ${urlInput}`, 'info');
            fileNameEl.textContent = `‚è≥ ƒêang t·∫£i t·ª´ URL...`;
            fileNameEl.style.color = 'orange';

            try {
                // Th·ª≠ t·∫£i file ƒë·ªÉ ki·ªÉm tra
                const testResponse = await fetch(urlInput, { method: 'HEAD' });
                if (!testResponse.ok) {
                    throw new Error(`Kh√¥ng th·ªÉ truy c·∫≠p file (HTTP ${testResponse.status}). Ki·ªÉm tra l·∫°i URL ho·∫∑c quy·ªÅn truy c·∫≠p.`);
                }

                // T·∫°o manifest tr·ªè TR·ª∞C TI·∫æP ƒë·∫øn URL t·ª´ GitHub
                const manifest = {
                    name: `Online Firmware`,
                    version: "1.0.0",
                    builds: [{
                        chipFamily: "ESP32-S3",
                        parts: [{ path: urlInput, offset: 0x00000 }] // ƒê∆∞·ªùng d·∫´n tr·ª±c ti·∫øp
                    }]
                };

                // T·∫°o manifest d∆∞·ªõi d·∫°ng Blob URL
                const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                const manifestUrl = URL.createObjectURL(manifestBlob);

                // C·∫≠p nh·∫≠t n√∫t c√†i ƒë·∫∑t
                updateInstallButton(manifestUrl);
                // L∆∞u ƒë·ªëi t∆∞·ª£ng ƒë·ªÉ d·ªçn d·∫πp
                currentManifestObject = { manifestUrl };

                fileNameEl.textContent = `üåê Firmware Online [ƒê√£ s·∫µn s√†ng]`;
                fileNameEl.style.color = 'var(--success)';
                addLog(`‚úÖ ƒê√£ thi·∫øt l·∫≠p firmware t·ª´ URL th√†nh c√¥ng!`, 'success');
                addLog('B·∫•m "K·∫øt n·ªëi..." ƒë·ªÉ b·∫Øt ƒë·∫ßu n·∫°p. File s·∫Ω ƒë∆∞·ª£c t·∫£i tr·ª±c ti·∫øp t·ª´ li√™n k·∫øt.', 'info');

            } catch (error) {
                addLog(`‚ùå L·ªói khi t·∫£i t·ª´ URL: ${error.message}`, 'error');
                fileNameEl.textContent = '‚ùå T·∫£i th·∫•t b·∫°i!';
                fileNameEl.style.color = 'var(--danger)';
                alert(`Kh√¥ng th·ªÉ t·∫£i file t·ª´ URL:\n${error.message}\n\nH√£y ki·ªÉm tra:\n1. URL c√≥ ƒë√∫ng kh√¥ng?\n2. File c√≥ c√¥ng khai kh√¥ng? (GitHub: d√πng Raw URL)\n3. C√≥ v·∫•n ƒë·ªÅ m·∫°ng kh√¥ng?`);
            }
        }

        // ========== H√ÄM C·∫¨P NH·∫¨T N√öT C√ÄI ƒê·∫∂T & THEO D√ïI TR·∫†NG TH√ÅI ==========
        const installButton = document.getElementById('installButton');

        function updateInstallButton(manifestUrl) {
            // X√≥a manifest c≈© v√† thi·∫øt l·∫≠p c√°i m·ªõi
            if (installButton.hasAttribute('manifest')) {
                installButton.removeAttribute('manifest');
            }
            // D√πng setTimeout nh·ªè ƒë·ªÉ ƒë·∫£m b·∫£o DOM c·∫≠p nh·∫≠t
            setTimeout(() => installButton.setAttribute('manifest', manifestUrl), 50);
        }

        // L·∫ÆNG NGHE S·ª∞ KI·ªÜN TH·ª∞C T·∫æ T·ª™ ESP-WEB-TOOLS
        installButton.addEventListener('state-changed', (event) => {
            const state = event.detail.state;
            switch (state) {
                case 'idle':
                    addLog('[Tr·∫°ng th√°i] S·∫µn s√†ng.', 'info');
                    break;
                case 'installing':
                    addLog('[Tr·∫°ng th√°i] üî• ƒêang n·∫°p firmware v√†o ESP32-S3...', 'warning');
                    break;
                case 'installed':
                    addLog('[Tr·∫°ng th√°i] ‚úÖ N·∫°p firmware HO√ÄN T·∫§T! Thi·∫øt b·ªã s·∫Ω kh·ªüi ƒë·ªông l·∫°i.', 'success');
                    // D·ªçn d·∫πp b·ªô nh·ªõ cho Object URL sau khi ho√†n th√†nh
                    cleanupObjectUrls();
                    break;
                case 'error':
                    addLog(`[Tr·∫°ng th√°i] ‚ùå L·ªói trong qu√° tr√¨nh n·∫°p: ${event.detail.message || 'Kh√¥ng r√µ'}`, 'error');
                    break;
            }
        });

        // L·∫Øng nghe c√°c s·ª± ki·ªán kh√°c ƒë·ªÉ log chi ti·∫øt
        installButton.addEventListener('device-connected', () => addLog('[Thi·∫øt b·ªã] ƒê√£ k·∫øt n·ªëi ESP32-S3.', 'success'));
        installButton.addEventListener('manifest-loaded', () => addLog('[Firmware] ƒê√£ x√°c th·ª±c th√¥ng tin firmware.', 'info'));

        // H√†m d·ªçn d·∫πp b·ªô nh·ªõ
        function cleanupObjectUrls() {
            if (currentManifestObject) {
                URL.revokeObjectURL(currentManifestObject.manifestUrl);
                if (currentManifestObject.fileObjectUrl) {
                    URL.revokeObjectURL(currentManifestObject.fileObjectUrl);
                }
                currentManifestObject = null;
                addLog('[H·ªá th·ªëng] ƒê√£ d·ªçn d·∫πp b·ªô nh·ªõ t·∫°m.', 'info');
            }
        }

        // ========== KH·ªûI T·∫†O ==========
        addLog('[H·ªá th·ªëng] C√¥ng c·ª• n·∫°p ESP32-S3 ƒë√£ kh·ªüi ƒë·ªông.', 'info');
        addLog('[H∆∞·ªõng d·∫´n] Ch·ªçn firmware theo 1 trong 2 c√°ch tr√™n, sau ƒë√≥ b·∫•m "K·∫øt n·ªëi...".', 'info');

        // C·∫•u h√¨nh URL m·∫∑c ƒë·ªãnh (·∫®n) - B·∫°n c√≥ th·ªÉ ƒë·∫∑t URL m·∫∑c ƒë·ªãnh c·ªßa m√¨nh ·ªü ƒë√¢y
        const DEFAULT_HIDDEN_URL = ''; // V√≠ d·ª•: 'https://github.com/username/repo/raw/main/firmware_v1.2.bin'
        if (DEFAULT_HIDDEN_URL) {
            document.getElementById('githubUrl').value = DEFAULT_HIDDEN_URL;
            addLog(`[H·ªá th·ªëng] ƒê√£ n·∫°p URL firmware m·∫∑c ƒë·ªãnh (·∫©n).`, 'info');
        }
    </script>
</body>
</html>
